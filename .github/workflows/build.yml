name: Build Hi3650 Kernel with KernelSU

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. 安装 HiSilicon 专用工具链（Linaro GCC 7.5）
      - name: Setup HiSilicon Toolchain
        run: |
          wget -q https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/aarch64-linux-gnu/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
          tar -xf gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu.tar.xz
          echo "$(pwd)/gcc-linaro-7.5.0-2019.12-x86_64_aarch64-linux-gnu/bin" >> $GITHUB_PATH
          export CROSS_COMPILE=aarch64-linux-gnu-

      # 2. 编译内核（Hi3650 专用）
      - name: Build Kernel
        run: |
          export ARCH=arm64
          make hi3650_defconfig  # 或 hi3660_defconfig（如果 hi3650 不存在）
          make -j$(nproc)

      # 3. 集成 KernelSU（兼容 4.4 内核）
      - name: Integrate KernelSU
        run: |
          export KERNELSU_TAG=v0.9.2  # 指定兼容旧内核的版本
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          make -j$(nproc) modules

      # 4. 打包内核（适配华为 Hi3650）
      - name: Package Kernel
        run: |
          git clone https://github.com/osm0sis/AnyKernel3
          cp arch/arm64/boot/Image.gz-dtb AnyKernel3/
          echo 'block=/dev/block/platform/hi_mci.0/by-name/boot' >> AnyKernel3/anykernel.sh
          echo 'device.name1=hi3650' >> AnyKernel3/anykernel.sh
          cd AnyKernel3
          zip -r9 kernel_kernelsu.zip *

      # 5. 上传产物
      - uses: actions/upload-artifact@v4
        with:
          name: kernel_kernelsu_hi3650
          path: AnyKernel3/kernel_kernelsu.zip
